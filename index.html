<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VentasPro ‚Äî Sistema de Ventas</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0e0f13;
    --surface: #16181f;
    --surface2: #1e2029;
    --border: #2a2d3a;
    --accent: #f0c040;
    --accent2: #e07030;
    --text: #e8eaf0;
    --text-muted: #7880a0;
    --green: #30d090;
    --red: #f05060;
    --blue: #4090f0;
    --radius: 12px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

  /* ===== AUTH SCREEN ===== */
  #auth-screen {
    position: fixed; inset: 0; z-index: 9000;
    background: var(--bg);
    display: flex; align-items: center; justify-content: center;
  }
  #auth-screen.hidden { display: none; }
  .auth-bg { position: absolute; inset: 0; overflow: hidden; }
  .auth-bg-grid {
    position: absolute; inset: -50%;
    background-image: linear-gradient(var(--border) 1px, transparent 1px), linear-gradient(90deg, var(--border) 1px, transparent 1px);
    background-size: 48px 48px; opacity: .35;
    animation: gridDrift 25s linear infinite;
  }
  @keyframes gridDrift { to { transform: translate(48px, 48px); } }
  .auth-glow {
    position: absolute; top: -20%; left: 50%; transform: translateX(-50%);
    width: 700px; height: 500px;
    background: radial-gradient(ellipse, rgba(240,192,64,.1) 0%, transparent 65%);
  }
  .auth-glow2 {
    position: absolute; bottom: -5%; right: 5%;
    width: 350px; height: 350px;
    background: radial-gradient(ellipse, rgba(64,144,240,.07) 0%, transparent 65%);
  }
  .auth-card {
    position: relative; z-index: 1;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 20px; padding: 40px; width: 100%; max-width: 420px;
    box-shadow: 0 40px 80px rgba(0,0,0,.5);
    animation: cardIn .4s ease;
  }
  @keyframes cardIn { from { opacity:0; transform:translateY(24px); } to { opacity:1; transform:translateY(0); } }
  .auth-logo { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 26px; color: var(--accent); letter-spacing: -1px; margin-bottom: 4px; }
  .auth-logo span { color: var(--text-muted); font-weight: 400; }
  .auth-tagline { font-size: 13px; color: var(--text-muted); margin-bottom: 28px; }
  .auth-screen-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 17px; margin-bottom: 18px; }
  .auth-form { display: flex; flex-direction: column; gap: 13px; }
  .auth-field { position: relative; }
  .auth-field input {
    width: 100%; padding: 12px 16px 12px 42px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 10px; color: var(--text);
    font-family: 'DM Sans', sans-serif; font-size: 14px; outline: none;
    transition: border-color .2s;
  }
  .auth-field input:focus { border-color: var(--accent); }
  .auth-field-icon { position: absolute; left: 13px; top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none; }
  .auth-eye { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 2px; }
  .auth-row { display: flex; align-items: center; justify-content: space-between; margin-top: 2px; }
  .auth-check { display: flex; align-items: center; gap: 7px; font-size: 13px; color: var(--text-muted); cursor: pointer; user-select: none; }
  .auth-check input[type=checkbox] { accent-color: var(--accent); width: 14px; height: 14px; }
  .auth-link { background: none; border: none; color: var(--accent); font-size: 13px; cursor: pointer; text-decoration: underline; padding: 0; }
  .auth-btn {
    background: var(--accent); color: #000; border: none; border-radius: 10px;
    padding: 13px; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 15px;
    cursor: pointer; transition: all .2s; margin-top: 6px; width: 100%;
  }
  .auth-btn:hover { background: #f5d060; transform: translateY(-1px); }
  .auth-msg { border-radius: 8px; padding: 10px 14px; font-size: 13px; display: none; margin-bottom: 4px; }
  .auth-msg.error { background: rgba(240,80,96,.1); border: 1px solid rgba(240,80,96,.3); color: var(--red); display: block; }
  .auth-msg.success { background: rgba(48,208,144,.1); border: 1px solid rgba(48,208,144,.3); color: var(--green); display: block; }
  .demo-section { margin-top: 22px; padding-top: 18px; border-top: 1px solid var(--border); }
  .demo-label { font-size: 10px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 10px; }
  .demo-chips { display: flex; flex-wrap: wrap; gap: 7px; }
  .demo-chip {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 7px;
    padding: 7px 12px; font-size: 12px; cursor: pointer; transition: all .2s;
    display: flex; align-items: center; gap: 6px;
  }
  .demo-chip:hover { border-color: var(--accent); color: var(--accent); }
  .demo-chip-role { font-size: 10px; color: var(--text-muted); }

  /* ===== LAYOUT ===== */
  .app { display: grid; grid-template-columns: 220px 1fr; grid-template-rows: auto 1fr; min-height: 100vh; }
  .topbar { grid-column: 1/-1; display: flex; align-items: center; gap: 16px; padding: 14px 28px; border-bottom: 1px solid var(--border); background: var(--surface); }
  .topbar-logo { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 20px; color: var(--accent); letter-spacing: -0.5px; }
  .topbar-logo span { color: var(--text-muted); font-weight: 400; }
  .topbar-right { margin-left: auto; display: flex; align-items: center; gap: 12px; }
  .topbar-date { font-size: 13px; color: var(--text-muted); }
  .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--accent); color: #000; font-family: 'Syne', sans-serif; font-weight: 800; font-size: 13px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .user-info { display: flex; flex-direction: column; }
  .user-name { font-size: 13px; font-weight: 600; line-height: 1; }
  .user-role-tag { font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 10px; text-transform: uppercase; letter-spacing: .5px; margin-top: 2px; display: inline-block; }
  .role-admin { background: rgba(240,192,64,.15); color: var(--accent); }
  .role-vendedor { background: rgba(64,144,240,.15); color: var(--blue); }
  .role-bodega { background: rgba(48,208,144,.15); color: var(--green); }
  .btn-logout { background: none; border: 1px solid var(--border); border-radius: 6px; color: var(--text-muted); padding: 5px 11px; font-size: 12px; cursor: pointer; transition: all .2s; font-family: 'DM Sans', sans-serif; }
  .btn-logout:hover { border-color: var(--red); color: var(--red); }

  /* SIDEBAR */
  .sidebar { background: var(--surface); border-right: 1px solid var(--border); padding: 20px 12px; display: flex; flex-direction: column; gap: 4px; }
  .nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; color: var(--text-muted); transition: all .2s; border: none; background: none; width: 100%; text-align: left; }
  .nav-item:hover { background: var(--surface2); color: var(--text); }
  .nav-item.active { background: var(--accent); color: #000; font-weight: 700; }
  .nav-item svg { flex-shrink: 0; }
  .nav-section { font-size: 10px; font-weight: 700; letter-spacing: 1.5px; color: var(--text-muted); padding: 14px 14px 6px; text-transform: uppercase; }
  .nav-item.hidden { display: none !important; }

  /* MAIN */
  .main { padding: 28px; overflow-y: auto; }
  .page { display: none; }
  .page.active { display: block; }

  /* CARDS */
  .page-title { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 26px; margin-bottom: 24px; }
  .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; margin-bottom: 28px; }
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
  .card-label { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; font-weight: 500; letter-spacing: .5px; }
  .card-value { font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 800; }
  .card-value.green { color: var(--green); }
  .card-value.accent { color: var(--accent); }
  .card-value.blue { color: var(--blue); }
  .card-value.red { color: var(--red); }
  .card-sub { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

  /* TABLES */
  .table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
  .table-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--border); }
  .table-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 16px; }
  table { width: 100%; border-collapse: collapse; }
  th { text-align: left; padding: 12px 16px; font-size: 11px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: var(--text-muted); border-bottom: 1px solid var(--border); }
  td { padding: 12px 16px; font-size: 14px; border-bottom: 1px solid var(--border); vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: var(--surface2); }
  .badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
  .badge.green { background: rgba(48,208,144,.15); color: var(--green); }
  .badge.red { background: rgba(240,80,96,.15); color: var(--red); }
  .badge.yellow { background: rgba(240,192,64,.15); color: var(--accent); }
  .badge.blue { background: rgba(64,144,240,.15); color: var(--blue); }

  /* BUTTONS */
  .btn { display: inline-flex; align-items: center; gap: 7px; padding: 9px 18px; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; border: none; transition: all .2s; }
  .btn-primary { background: var(--accent); color: #000; }
  .btn-primary:hover { background: #f5d060; transform: translateY(-1px); }
  .btn-ghost { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
  .btn-danger { background: rgba(240,80,96,.15); color: var(--red); border: 1px solid rgba(240,80,96,.3); }
  .btn-danger:hover { background: rgba(240,80,96,.3); }
  .btn-sm { padding: 5px 12px; font-size: 12px; }

  /* FORMS */
  .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; }
  .form-group { display: flex; flex-direction: column; gap: 6px; }
  .form-group.full { grid-column: 1/-1; }
  label { font-size: 12px; font-weight: 600; color: var(--text-muted); letter-spacing: .5px; text-transform: uppercase; }
  input, select, textarea { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); padding: 10px 14px; font-family: 'DM Sans', sans-serif; font-size: 14px; outline: none; transition: border-color .2s; width: 100%; }
  input:focus, select:focus, textarea:focus { border-color: var(--accent); }
  input::placeholder { color: var(--text-muted); }
  select option { background: var(--surface2); }

  /* MODAL */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.7); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 28px; width: 100%; max-width: 520px; max-height: 90vh; overflow-y: auto; }
  .modal-title { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 20px; margin-bottom: 20px; }
  .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

  /* CHARTS */
  .chart-bar-wrap { display: flex; flex-direction: column; gap: 10px; padding: 16px 20px; }
  .bar-row { display: flex; align-items: center; gap: 12px; }
  .bar-label { width: 120px; font-size: 13px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .bar-track { flex: 1; height: 8px; background: var(--surface2); border-radius: 4px; overflow: hidden; }
  .bar-fill { height: 100%; border-radius: 4px; background: var(--accent); transition: width .6s ease; }
  .bar-val { font-size: 13px; font-weight: 600; width: 80px; text-align: right; }

  /* SALE PAGE */
  .sale-layout { display: grid; grid-template-columns: 1fr 360px; gap: 20px; }
  .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
  .product-card { background: var(--surface); border: 2px solid var(--border); border-radius: var(--radius); padding: 16px; cursor: pointer; transition: all .2s; text-align: center; }
  .product-card:hover { border-color: var(--accent); transform: translateY(-2px); }
  .product-card.low-stock { border-color: rgba(240,80,96,.4); }
  .product-emoji { font-size: 32px; margin-bottom: 8px; }
  .product-name { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
  .product-price { color: var(--accent); font-weight: 700; font-size: 15px; }
  .product-stock-badge { font-size: 11px; color: var(--text-muted); margin-top: 3px; }
  .cart { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; position: sticky; top: 0; }
  .cart-title { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 18px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
  .cart-items { min-height: 120px; margin-bottom: 16px; }
  .cart-item { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border); }
  .cart-item-name { flex: 1; font-size: 14px; }
  .cart-qty { display: flex; align-items: center; gap: 6px; }
  .qty-btn { background: var(--surface2); border: 1px solid var(--border); border-radius: 4px; width: 24px; height: 24px; cursor: pointer; color: var(--text); font-size: 14px; display: flex; align-items: center; justify-content: center; }
  .qty-num { font-weight: 700; font-size: 14px; min-width: 20px; text-align: center; }
  .cart-item-total { font-weight: 700; color: var(--accent); font-size: 14px; }
  .cart-total { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-top: 2px solid var(--border); font-family: 'Syne', sans-serif; font-weight: 800; font-size: 20px; }
  .cart-empty { text-align: center; color: var(--text-muted); font-size: 13px; padding: 20px 0; }
  .search-bar { position: relative; }
  .search-bar input { padding-left: 38px; }
  .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

  /* SCROLLBAR */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* TOAST */
  #toast { position: fixed; bottom: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
  .toast-msg { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 12px 18px; font-size: 14px; font-weight: 500; opacity: 0; transform: translateY(10px); transition: all .3s; max-width: 280px; }
  .toast-msg.show { opacity: 1; transform: translateY(0); }
  .toast-msg.success { border-color: var(--green); color: var(--green); }
  .toast-msg.error { border-color: var(--red); color: var(--red); }

  /* ACCESS DENIED */
  .access-denied { text-align: center; padding: 60px 20px; }
  .access-denied-icon { font-size: 48px; margin-bottom: 16px; }
  .access-denied h2 { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 22px; margin-bottom: 8px; color: var(--red); }
  .access-denied p { color: var(--text-muted); font-size: 14px; }

  @media (max-width: 900px) {
    .app { grid-template-columns: 1fr; }
    .sidebar { flex-direction: row; overflow-x: auto; padding: 8px; border-right: none; border-bottom: 1px solid var(--border); }
    .nav-section { display: none; }
    .sale-layout, .two-col { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div id="toast"></div>

<!-- ===== AUTH SCREEN ===== -->
<div id="auth-screen">
  <div class="auth-bg">
    <div class="auth-bg-grid"></div>
    <div class="auth-glow"></div>
    <div class="auth-glow2"></div>
  </div>
  <div class="auth-card">
    <div class="auth-logo">Ventas<span>Pro</span></div>
    <div class="auth-tagline">Sistema de gesti√≥n de ventas</div>

    <!-- LOGIN FORM -->
    <div id="auth-login">
      <div class="auth-screen-title">Iniciar Sesi√≥n</div>
      <div id="login-msg" class="auth-msg"></div>
      <div class="auth-form">
        <div class="auth-field">
          <span class="auth-field-icon"><svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></span>
          <input type="text" id="login-user" placeholder="Usuario o email" autocomplete="username">
        </div>
        <div class="auth-field">
          <span class="auth-field-icon"><svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg></span>
          <input type="password" id="login-pass" placeholder="Contrase√±a" autocomplete="current-password">
          <button class="auth-eye" onclick="togglePass('login-pass', this)" tabindex="-1">
            <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
        </div>
        <div class="auth-row">
          <label class="auth-check"><input type="checkbox" id="remember-me"> Recordar sesi√≥n</label>
          <button class="auth-link" onclick="showScreen('recovery')">¬øOlvidaste tu contrase√±a?</button>
        </div>
        <button class="auth-btn" onclick="doLogin()">Entrar</button>
      </div>
      <div class="demo-section">
        <div class="demo-label">Usuarios de prueba</div>
        <div class="demo-chips">
          <div class="demo-chip" onclick="fillDemo('admin','admin123')">üëë Admin <span class="demo-chip-role">admin123</span></div>
          <div class="demo-chip" onclick="fillDemo('vendedor1','venta123')">üõí Vendedor <span class="demo-chip-role">venta123</span></div>
          <div class="demo-chip" onclick="fillDemo('bodega1','bodega123')">üì¶ Bodega <span class="demo-chip-role">bodega123</span></div>
        </div>
      </div>
    </div>

    <!-- RECOVERY FORM -->
    <div id="auth-recovery" style="display:none">
      <div class="auth-screen-title">Recuperar Contrase√±a</div>
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:16px">Ingresa tu email y te mostraremos c√≥mo recuperar el acceso.</p>
      <div id="recovery-msg" class="auth-msg"></div>
      <div class="auth-form">
        <div class="auth-field">
          <span class="auth-field-icon"><svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></span>
          <input type="email" id="recovery-email" placeholder="tu@email.com">
        </div>
        <button class="auth-btn" onclick="doRecovery()">Enviar instrucciones</button>
        <button class="auth-link" style="text-align:center;margin-top:4px" onclick="showScreen('login')">‚Üê Volver al login</button>
      </div>
    </div>

  </div>
</div>

<!-- ===== APP ===== -->
<div class="app" id="app-main" style="display:none">
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbar-logo">Ventas<span>Pro</span></div>
    <div class="topbar-right">
      <div class="topbar-date" id="topbar-date"></div>
      <div class="user-avatar" id="topbar-avatar"></div>
      <div class="user-info">
        <div class="user-name" id="topbar-username"></div>
        <span class="user-role-tag" id="topbar-role"></span>
      </div>
      <button class="btn-logout" onclick="doLogout()">Salir</button>
    </div>
  </div>

  <!-- SIDEBAR -->
  <nav class="sidebar">
    <div class="nav-section">Principal</div>
    <button class="nav-item active" id="nav-dashboard" onclick="navigate('dashboard')">
      <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
      Dashboard
    </button>
    <button class="nav-item" id="nav-ventas" onclick="navigate('ventas')">
      <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
      Nueva Venta
    </button>
    <div class="nav-section">Gesti√≥n</div>
    <button class="nav-item" id="nav-productos" onclick="navigate('productos')">
      <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M20 7H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
      Productos
    </button>
    <button class="nav-item" id="nav-inventario" onclick="navigate('inventario')">
      <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
      Inventario
    </button>
    <button class="nav-item" id="nav-clientes" onclick="navigate('clientes')">
      <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
      Clientes
    </button>
    <div class="nav-section">An√°lisis</div>
    <button class="nav-item" id="nav-reportes" onclick="navigate('reportes')">
      <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      Reportes
    </button>
    <button class="nav-item" id="nav-historial" onclick="navigate('historial')">
      <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>
      Historial
    </button>
    <button class="nav-item" id="nav-usuarios" onclick="navigate('usuarios')">
      <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="23" y1="11" x2="17" y2="11"/><line x1="20" y1="8" x2="20" y2="14"/></svg>
      Usuarios
    </button>
  </nav>

  <!-- MAIN CONTENT -->
  <main class="main">

    <!-- DASHBOARD -->
    <div class="page active" id="page-dashboard">
      <div class="page-title">Dashboard</div>
      <div class="cards-grid" id="dash-cards"></div>
      <div class="two-col">
        <div class="table-wrap">
          <div class="table-header"><span class="table-title">üèÜ Productos Top</span></div>
          <div class="chart-bar-wrap" id="top-products-chart"></div>
        </div>
        <div class="table-wrap">
          <div class="table-header"><span class="table-title">‚ö° √öltimas Ventas</span></div>
          <table><thead><tr><th>Cliente</th><th>Total</th><th>Fecha</th></tr></thead>
          <tbody id="recent-sales-table"></tbody></table>
        </div>
      </div>
    </div>

    <!-- NUEVA VENTA -->
    <div class="page" id="page-ventas">
      <div class="page-title">Nueva Venta</div>
      <div class="sale-layout">
        <div>
          <div class="search-bar" style="margin-bottom:16px">
            <span class="search-icon"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></span>
            <input type="text" id="product-search" placeholder="Buscar producto..." oninput="renderProductGrid()">
          </div>
          <div class="product-grid" id="product-grid"></div>
        </div>
        <div>
          <div class="cart">
            <div class="cart-title">
              <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
              Carrito
            </div>
            <div class="form-group" style="margin-bottom:14px">
              <label>Cliente</label>
              <select id="cart-client"><option value="">‚Äî Consumidor Final ‚Äî</option></select>
            </div>
            <div class="cart-items" id="cart-items"></div>
            <div class="cart-total">
              <span>Total</span>
              <span id="cart-total-val">$0.00</span>
            </div>
            <div class="form-group" style="margin:12px 0">
              <label>M√©todo de Pago</label>
              <select id="payment-method">
                <option>Efectivo</option><option>Tarjeta</option><option>Transferencia</option><option>Otro</option>
              </select>
            </div>
            <button class="btn btn-primary" style="width:100%;justify-content:center" onclick="finalizeSale()">
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="20,6 9,17 4,12"/></svg>
              Confirmar Venta
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- PRODUCTOS -->
    <div class="page" id="page-productos">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px">
        <div class="page-title" style="margin:0">Productos</div>
        <button class="btn btn-primary" id="btn-new-product" onclick="openProductModal()">
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Nuevo Producto
        </button>
      </div>
      <div class="table-wrap">
        <table><thead><tr><th>Producto</th><th>Categor√≠a</th><th>Precio Costo</th><th>Precio Venta</th><th>Stock</th><th>Acciones</th></tr></thead>
        <tbody id="products-table"></tbody></table>
      </div>
    </div>

    <!-- INVENTARIO -->
    <div class="page" id="page-inventario">
      <div class="page-title">Control de Inventario</div>
      <div class="cards-grid" id="inv-cards"></div>
      <div class="table-wrap">
        <div class="table-header">
          <span class="table-title">Estado del Stock</span>
          <button class="btn btn-ghost btn-sm" id="btn-adjust" onclick="openAdjustModal()">Ajuste Manual</button>
        </div>
        <table><thead><tr><th>Producto</th><th>Stock Actual</th><th>Stock M√≠nimo</th><th>Estado</th></tr></thead>
        <tbody id="inventory-table"></tbody></table>
      </div>
    </div>

    <!-- CLIENTES -->
    <div class="page" id="page-clientes">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px">
        <div class="page-title" style="margin:0">Clientes</div>
        <button class="btn btn-primary" onclick="openClientModal()">
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Nuevo Cliente
        </button>
      </div>
      <div class="table-wrap">
        <table><thead><tr><th>Nombre</th><th>Tel√©fono</th><th>Email</th><th>Total Compras</th><th>Acciones</th></tr></thead>
        <tbody id="clients-table"></tbody></table>
      </div>
    </div>

    <!-- REPORTES -->
    <div class="page" id="page-reportes">
      <div class="page-title">Reportes y Estad√≠sticas</div>
      <div class="cards-grid" id="report-cards"></div>
      <div class="two-col">
        <div class="table-wrap">
          <div class="table-header"><span class="table-title">üèÜ Top 5 Productos</span></div>
          <div class="chart-bar-wrap" id="report-top-chart"></div>
        </div>
        <div class="table-wrap">
          <div class="table-header"><span class="table-title">üí∞ Ventas por M√©todo de Pago</span></div>
          <div class="chart-bar-wrap" id="report-payment-chart"></div>
        </div>
      </div>
      <div style="margin-top:20px" class="table-wrap">
        <div class="table-header"><span class="table-title">üìã Resumen por Categor√≠a</span></div>
        <table><thead><tr><th>Categor√≠a</th><th>Productos</th><th>Unidades Vendidas</th><th>Ingresos</th></tr></thead>
        <tbody id="category-report-table"></tbody></table>
      </div>
    </div>

    <!-- HISTORIAL -->
    <div class="page" id="page-historial">
      <div class="page-title">Historial de Ventas</div>
      <div class="table-wrap">
        <div class="table-header">
          <span class="table-title">Todas las Ventas</span>
          <div style="display:flex;gap:8px">
            <input type="date" id="filter-date" oninput="renderHistorial()" style="width:160px;padding:6px 10px;font-size:13px">
            <button class="btn btn-ghost btn-sm" onclick="document.getElementById('filter-date').value='';renderHistorial()">Limpiar</button>
          </div>
        </div>
        <table><thead><tr><th>#</th><th>Fecha</th><th>Vendedor</th><th>Cliente</th><th>Productos</th><th>Pago</th><th>Total</th></tr></thead>
        <tbody id="historial-table"></tbody></table>
      </div>
    </div>

    <!-- USUARIOS (solo admin) -->
    <div class="page" id="page-usuarios">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px">
        <div class="page-title" style="margin:0">Gesti√≥n de Usuarios</div>
        <button class="btn btn-primary" onclick="openUserModal()">
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Nuevo Usuario
        </button>
      </div>
      <div class="table-wrap">
        <table><thead><tr><th>Usuario</th><th>Nombre</th><th>Email</th><th>Rol</th><th>Acciones</th></tr></thead>
        <tbody id="users-table"></tbody></table>
      </div>
    </div>

  </main>
</div>

<!-- MODAL PRODUCTO -->
<div class="modal-overlay" id="modal-product">
  <div class="modal">
    <div class="modal-title" id="modal-product-title">Nuevo Producto</div>
    <div class="form-grid">
      <div class="form-group"><label>Nombre</label><input id="p-name" placeholder="Ej: Camiseta Azul"></div>
      <div class="form-group"><label>Emoji / √çcono</label><input id="p-emoji" placeholder="üì¶" maxlength="2"></div>
      <div class="form-group"><label>Categor√≠a</label><input id="p-cat" placeholder="Ropa, Electr√≥nica..."></div>
      <div class="form-group"><label>Precio de Costo</label><input id="p-cost" type="number" placeholder="0.00" min="0"></div>
      <div class="form-group"><label>Precio de Venta</label><input id="p-price" type="number" placeholder="0.00" min="0"></div>
      <div class="form-group"><label>Stock Inicial</label><input id="p-stock" type="number" placeholder="0" min="0"></div>
      <div class="form-group"><label>Stock M√≠nimo (alerta)</label><input id="p-minstock" type="number" placeholder="5" min="0"></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modal-product')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveProduct()">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL CLIENTE -->
<div class="modal-overlay" id="modal-client">
  <div class="modal">
    <div class="modal-title">Nuevo Cliente</div>
    <div class="form-grid">
      <div class="form-group full"><label>Nombre Completo</label><input id="c-name" placeholder="Juan P√©rez"></div>
      <div class="form-group"><label>Tel√©fono</label><input id="c-phone" placeholder="+54 9 ..."></div>
      <div class="form-group"><label>Email</label><input id="c-email" type="email" placeholder="correo@..."></div>
      <div class="form-group full"><label>Notas</label><input id="c-notes" placeholder="Cliente frecuente, etc."></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modal-client')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveClient()">Guardar</button>
    </div>
  </div>
</div>

<!-- MODAL AJUSTE INVENTARIO -->
<div class="modal-overlay" id="modal-adjust">
  <div class="modal">
    <div class="modal-title">Ajuste Manual de Stock</div>
    <div class="form-grid">
      <div class="form-group full"><label>Producto</label><select id="adj-product"></select></div>
      <div class="form-group"><label>Tipo</label>
        <select id="adj-type">
          <option value="add">‚ûï Agregar Stock</option>
          <option value="remove">‚ûñ Reducir Stock</option>
          <option value="set">üîß Establecer Cantidad</option>
        </select>
      </div>
      <div class="form-group"><label>Cantidad</label><input id="adj-qty" type="number" placeholder="0" min="0"></div>
      <div class="form-group full"><label>Motivo</label><input id="adj-reason" placeholder="Compra, merma, correcci√≥n..."></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modal-adjust')">Cancelar</button>
      <button class="btn btn-primary" onclick="applyAdjust()">Aplicar</button>
    </div>
  </div>
</div>

<!-- MODAL USUARIO -->
<div class="modal-overlay" id="modal-user">
  <div class="modal">
    <div class="modal-title" id="modal-user-title">Nuevo Usuario</div>
    <div class="form-grid">
      <div class="form-group"><label>Usuario</label><input id="u-username" placeholder="juan.perez"></div>
      <div class="form-group"><label>Nombre Completo</label><input id="u-fullname" placeholder="Juan P√©rez"></div>
      <div class="form-group"><label>Email</label><input id="u-email" type="email" placeholder="correo@..."></div>
      <div class="form-group"><label>Rol</label>
        <select id="u-role">
          <option value="vendedor">üõí Vendedor</option>
          <option value="bodega">üì¶ Bodega</option>
          <option value="admin">üëë Admin</option>
        </select>
      </div>
      <div class="form-group"><label>Contrase√±a</label><input id="u-pass" type="password" placeholder="M√≠nimo 6 caracteres"></div>
      <div class="form-group"><label>Confirmar Contrase√±a</label><input id="u-pass2" type="password" placeholder="Repetir contrase√±a"></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modal-user')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveUser()">Guardar</button>
    </div>
  </div>
</div>

<script>
// ======================== ROLES CONFIG ========================
const ROLES = {
  admin:    { label: 'Admin',    color: 'role-admin',    pages: ['dashboard','ventas','productos','inventario','clientes','reportes','historial','usuarios'] },
  vendedor: { label: 'Vendedor', color: 'role-vendedor', pages: ['dashboard','ventas','clientes','historial'] },
  bodega:   { label: 'Bodega',   color: 'role-bodega',   pages: ['dashboard','inventario','productos','historial'] },
};

// ======================== DATA STORE ========================
let store = JSON.parse(localStorage.getItem('ventaspro') || 'null') || {
  users: [
    { id:1, username:'admin',     fullname:'Administrador', email:'admin@tienda.com',    role:'admin',    password:'admin123' },
    { id:2, username:'vendedor1', fullname:'Ana Vendedora',  email:'ana@tienda.com',      role:'vendedor', password:'venta123' },
    { id:3, username:'bodega1',   fullname:'Luis Bodega',    email:'luis@tienda.com',     role:'bodega',   password:'bodega123' },
  ],
  products: [
    { id:1, name:'Camiseta B√°sica', emoji:'üëï', category:'Ropa', cost:8, price:20, stock:45, minStock:5 },
    { id:2, name:'Pantal√≥n Jean',   emoji:'üëñ', category:'Ropa', cost:18, price:45, stock:20, minStock:3 },
    { id:3, name:'Zapatillas',      emoji:'üëü', category:'Calzado', cost:30, price:70, stock:12, minStock:4 },
    { id:4, name:'Mochila',         emoji:'üéí', category:'Accesorios', cost:15, price:35, stock:8, minStock:2 },
    { id:5, name:'Gorra',           emoji:'üß¢', category:'Accesorios', cost:5, price:15, stock:3, minStock:5 },
    { id:6, name:'Reloj',           emoji:'‚åö', category:'Accesorios', cost:25, price:60, stock:6, minStock:2 },
  ],
  clients: [
    { id:1, name:'Mar√≠a Gonz√°lez', phone:'555-0101', email:'maria@email.com', notes:'' },
    { id:2, name:'Carlos Ruiz',    phone:'555-0202', email:'carlos@email.com', notes:'Cliente frecuente' },
  ],
  sales: [
    { id:1, date:'2026-02-14', seller:'Ana Vendedora', client:'Mar√≠a Gonz√°lez', items:[{name:'Camiseta B√°sica',qty:2,price:20},{name:'Gorra',qty:1,price:15}], payment:'Efectivo', total:55 },
    { id:2, date:'2026-02-15', seller:'Ana Vendedora', client:'Carlos Ruiz',    items:[{name:'Pantal√≥n Jean',qty:1,price:45}], payment:'Tarjeta', total:45 },
    { id:3, date:'2026-02-16', seller:'Administrador', client:'Consumidor Final', items:[{name:'Zapatillas',qty:1,price:70},{name:'Mochila',qty:1,price:35}], payment:'Efectivo', total:105 },
    { id:4, date:'2026-02-17', seller:'Ana Vendedora', client:'Mar√≠a Gonz√°lez', items:[{name:'Reloj',qty:1,price:60}], payment:'Transferencia', total:60 },
  ],
  nextProductId:7, nextClientId:3, nextSaleId:5, nextUserId:4,
};

let currentUser = null;
let cart = [];
let editingProductId = null;
let editingUserId = null;

function save() { localStorage.setItem('ventaspro', JSON.stringify(store)); }

// ======================== AUTH ========================
function showScreen(screen) {
  document.getElementById('auth-login').style.display = screen === 'login' ? 'block' : 'none';
  document.getElementById('auth-recovery').style.display = screen === 'recovery' ? 'block' : 'none';
  clearMsg('login-msg'); clearMsg('recovery-msg');
}

function clearMsg(id) {
  const el = document.getElementById(id);
  el.className = 'auth-msg'; el.textContent = '';
}

function showMsg(id, text, type='error') {
  const el = document.getElementById(id);
  el.className = 'auth-msg ' + type; el.textContent = text;
}

function togglePass(inputId, btn) {
  const inp = document.getElementById(inputId);
  inp.type = inp.type === 'password' ? 'text' : 'password';
}

function fillDemo(user, pass) {
  document.getElementById('login-user').value = user;
  document.getElementById('login-pass').value = pass;
}

function doLogin() {
  const userVal = document.getElementById('login-user').value.trim();
  const passVal = document.getElementById('login-pass').value;
  const remember = document.getElementById('remember-me').checked;
  clearMsg('login-msg');
  if (!userVal || !passVal) { showMsg('login-msg', 'Completa usuario y contrase√±a'); return; }
  const user = store.users.find(u => (u.username === userVal || u.email === userVal) && u.password === passVal);
  if (!user) { showMsg('login-msg', 'Usuario o contrase√±a incorrectos'); return; }
  currentUser = user;
  if (remember) localStorage.setItem('ventaspro_session', JSON.stringify({ userId: user.id }));
  launchApp();
}

function doLogout() {
  currentUser = null;
  localStorage.removeItem('ventaspro_session');
  cart = [];
  document.getElementById('app-main').style.display = 'none';
  document.getElementById('auth-screen').classList.remove('hidden');
  document.getElementById('login-user').value = '';
  document.getElementById('login-pass').value = '';
  showScreen('login');
}

function doRecovery() {
  const email = document.getElementById('recovery-email').value.trim();
  if (!email) { showMsg('recovery-msg', 'Ingresa tu email'); return; }
  const user = store.users.find(u => u.email === email);
  if (!user) { showMsg('recovery-msg', 'No encontramos ese email'); return; }
  showMsg('recovery-msg', `‚úÖ Las instrucciones se enviar√≠an a ${email}. (En producci√≥n con backend se env√≠a el correo real.)`, 'success');
}

function launchApp() {
  document.getElementById('auth-screen').classList.add('hidden');
  document.getElementById('app-main').style.display = 'grid';
  applyRoleUI();
  document.getElementById('topbar-date').textContent = new Date().toLocaleDateString('es', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  navigate('dashboard');
}

function applyRoleUI() {
  const role = ROLES[currentUser.role];
  const initials = currentUser.fullname.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
  document.getElementById('topbar-avatar').textContent = initials;
  document.getElementById('topbar-username').textContent = currentUser.fullname;
  const roleEl = document.getElementById('topbar-role');
  roleEl.textContent = role.label;
  roleEl.className = 'user-role-tag ' + role.color;

  // Show/hide nav items based on role
  const allPages = ['dashboard','ventas','productos','inventario','clientes','reportes','historial','usuarios'];
  allPages.forEach(p => {
    const navEl = document.getElementById('nav-' + p);
    if (navEl) navEl.classList.toggle('hidden', !role.pages.includes(p));
  });
}

function checkAccess(page) {
  if (!currentUser) return false;
  return ROLES[currentUser.role].pages.includes(page);
}

// Auto-login from saved session
function tryAutoLogin() {
  const session = localStorage.getItem('ventaspro_session');
  if (session) {
    try {
      const { userId } = JSON.parse(session);
      const user = store.users.find(u => u.id === userId);
      if (user) { currentUser = user; launchApp(); return; }
    } catch(e) {}
  }
}

// ======================== NAVIGATION ========================
function navigate(page) {
  if (!checkAccess(page)) {
    // Find first accessible page
    const accessible = ROLES[currentUser.role].pages[0];
    page = accessible;
  }
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  const nav = document.getElementById('nav-' + page);
  if (nav) nav.classList.add('active');
  if (page === 'dashboard') renderDashboard();
  if (page === 'ventas') { renderProductGrid(); renderCart(); renderClientSelect(); }
  if (page === 'productos') renderProducts();
  if (page === 'inventario') renderInventory();
  if (page === 'clientes') renderClients();
  if (page === 'reportes') renderReports();
  if (page === 'historial') renderHistorial();
  if (page === 'usuarios') renderUsers();
}

// ======================== TOAST ========================
function toast(msg, type='success') {
  const el = document.createElement('div');
  el.className = 'toast-msg ' + type;
  el.textContent = msg;
  document.getElementById('toast').appendChild(el);
  setTimeout(() => el.classList.add('show'), 10);
  setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 300); }, 2800);
}

// ======================== DASHBOARD ========================
function renderDashboard() {
  const today = new Date().toISOString().split('T')[0];
  const todaySales = store.sales.filter(s => s.date === today);
  const totalRevenue = store.sales.reduce((a, s) => a + s.total, 0);
  const todayRevenue = todaySales.reduce((a, s) => a + s.total, 0);
  const totalProfit = calcProfit();
  const lowStock = store.products.filter(p => p.stock <= p.minStock).length;
  document.getElementById('dash-cards').innerHTML = `
    <div class="card"><div class="card-label">VENTAS HOY</div><div class="card-value accent">$${todayRevenue.toFixed(2)}</div><div class="card-sub">${todaySales.length} transacciones</div></div>
    <div class="card"><div class="card-label">INGRESOS TOTALES</div><div class="card-value green">$${totalRevenue.toFixed(2)}</div><div class="card-sub">${store.sales.length} ventas</div></div>
    <div class="card"><div class="card-label">GANANCIA TOTAL</div><div class="card-value blue">$${totalProfit.toFixed(2)}</div><div class="card-sub">margen estimado</div></div>
    <div class="card"><div class="card-label">STOCK BAJO</div><div class="card-value ${lowStock>0?'red':'green'}">${lowStock}</div><div class="card-sub">productos con alerta</div></div>
  `;
  const top = getTopProducts(5);
  const maxQ = top[0]?.qty || 1;
  document.getElementById('top-products-chart').innerHTML = top.map(p => `
    <div class="bar-row">
      <div class="bar-label">${p.emoji} ${p.name}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${p.qty/maxQ*100}%"></div></div>
      <div class="bar-val" style="color:var(--accent)">${p.qty} uds</div>
    </div>
  `).join('') || '<div style="padding:16px;color:var(--text-muted);font-size:13px">Sin ventas a√∫n</div>';
  const recent = [...store.sales].sort((a,b)=>b.id-a.id).slice(0,5);
  document.getElementById('recent-sales-table').innerHTML = recent.map(s => `
    <tr><td>${s.client}</td><td style="color:var(--accent);font-weight:700">$${s.total.toFixed(2)}</td><td style="color:var(--text-muted)">${s.date}</td></tr>
  `).join('') || '<tr><td colspan="3" style="text-align:center;color:var(--text-muted)">Sin ventas</td></tr>';
}

function calcProfit() {
  let p = 0;
  store.sales.forEach(sale => sale.items.forEach(item => {
    const prod = store.products.find(x => x.name === item.name);
    if (prod) p += (item.price - prod.cost) * item.qty;
  }));
  return p;
}

function getTopProducts(n=5) {
  const counts = {};
  store.sales.forEach(sale => sale.items.forEach(item => {
    if (!counts[item.name]) counts[item.name] = { name:item.name, qty:0, revenue:0 };
    counts[item.name].qty += item.qty;
    counts[item.name].revenue += item.price * item.qty;
  }));
  return Object.values(counts).sort((a,b)=>b.qty-a.qty).slice(0,n).map(x => {
    const p = store.products.find(pr=>pr.name===x.name);
    return { ...x, emoji: p?.emoji||'üì¶' };
  });
}

// ======================== VENTAS ========================
function renderClientSelect() {
  const sel = document.getElementById('cart-client');
  const cur = sel.value;
  sel.innerHTML = '<option value="">‚Äî Consumidor Final ‚Äî</option>' +
    store.clients.map(c=>`<option value="${c.name}" ${c.name===cur?'selected':''}>${c.name}</option>`).join('');
}

function renderProductGrid() {
  const q = document.getElementById('product-search')?.value.toLowerCase()||'';
  const prods = store.products.filter(p=>p.name.toLowerCase().includes(q)||p.category.toLowerCase().includes(q));
  document.getElementById('product-grid').innerHTML = prods.map(p=>`
    <div class="product-card ${p.stock<=p.minStock?'low-stock':''}" onclick="addToCart(${p.id})">
      <div class="product-emoji">${p.emoji||'üì¶'}</div>
      <div class="product-name">${p.name}</div>
      <div class="product-price">$${p.price.toFixed(2)}</div>
      <div class="product-stock-badge">${p.stock<=p.minStock?'‚ö†Ô∏è':'‚úÖ'} Stock: ${p.stock}</div>
    </div>
  `).join('');
}

function addToCart(productId) {
  const p = store.products.find(x=>x.id===productId);
  if (!p||p.stock<=0) { toast('Sin stock disponible','error'); return; }
  const ex = cart.find(x=>x.id===productId);
  if (ex) { if (ex.qty>=p.stock) { toast('No hay m√°s stock','error'); return; } ex.qty++; }
  else cart.push({ id:p.id, name:p.name, price:p.price, qty:1 });
  renderCart();
}

function renderCart() {
  const el = document.getElementById('cart-items');
  if (!cart.length) { el.innerHTML='<div class="cart-empty">Agrega productos haciendo clic en ellos</div>'; document.getElementById('cart-total-val').textContent='$0.00'; return; }
  el.innerHTML = cart.map(item=>`
    <div class="cart-item">
      <div class="cart-item-name">${item.name}</div>
      <div class="cart-qty">
        <button class="qty-btn" onclick="changeQty(${item.id},-1)">‚àí</button>
        <span class="qty-num">${item.qty}</span>
        <button class="qty-btn" onclick="changeQty(${item.id},1)">+</button>
      </div>
      <div class="cart-item-total">$${(item.price*item.qty).toFixed(2)}</div>
    </div>
  `).join('');
  document.getElementById('cart-total-val').textContent = '$' + cart.reduce((a,x)=>a+x.price*x.qty,0).toFixed(2);
}

function changeQty(id, delta) {
  const item = cart.find(x=>x.id===id);
  if (!item) return;
  const p = store.products.find(x=>x.id===id);
  item.qty += delta;
  if (item.qty<=0) cart=cart.filter(x=>x.id!==id);
  else if (p&&item.qty>p.stock) { item.qty=p.stock; toast('L√≠mite de stock alcanzado','error'); }
  renderCart();
}

function finalizeSale() {
  if (!cart.length) { toast('El carrito est√° vac√≠o','error'); return; }
  const client = document.getElementById('cart-client').value||'Consumidor Final';
  const payment = document.getElementById('payment-method').value;
  const total = cart.reduce((a,x)=>a+x.price*x.qty,0);
  const today = new Date().toISOString().split('T')[0];
  cart.forEach(item => { const p=store.products.find(x=>x.id===item.id); if(p) p.stock-=item.qty; });
  store.sales.push({ id:store.nextSaleId++, date:today, seller:currentUser.fullname, client, items:cart.map(x=>({name:x.name,qty:x.qty,price:x.price})), payment, total });
  save(); cart=[]; renderCart(); renderProductGrid();
  toast(`‚úÖ Venta de $${total.toFixed(2)} registrada`);
}

// ======================== PRODUCTOS ========================
function renderProducts() {
  const canEdit = checkAccess('usuarios') || currentUser.role==='admin' || currentUser.role==='bodega';
  document.getElementById('btn-new-product').style.display = canEdit ? '' : 'none';
  document.getElementById('products-table').innerHTML = store.products.map(p => {
    const margin = ((p.price-p.cost)/p.price*100).toFixed(0);
    return `<tr>
      <td><span style="margin-right:8px">${p.emoji||'üì¶'}</span><strong>${p.name}</strong></td>
      <td><span class="badge yellow">${p.category}</span></td>
      <td>$${p.cost.toFixed(2)}</td>
      <td style="color:var(--accent);font-weight:700">$${p.price.toFixed(2)} <span style="color:var(--text-muted);font-size:12px">(+${margin}%)</span></td>
      <td><span class="badge ${p.stock<=p.minStock?'red':'green'}">${p.stock} uds</span></td>
      <td>${canEdit?`<button class="btn btn-ghost btn-sm" onclick="openProductModal(${p.id})">‚úèÔ∏è</button> <button class="btn btn-danger btn-sm" onclick="deleteProduct(${p.id})">üóëÔ∏è</button>`:'‚Äî'}</td>
    </tr>`;
  }).join('') || '<tr><td colspan="6" style="text-align:center;color:var(--text-muted)">Sin productos</td></tr>';
}

function openProductModal(id=null) {
  editingProductId=id;
  document.getElementById('modal-product-title').textContent = id?'Editar Producto':'Nuevo Producto';
  if (id) { const p=store.products.find(x=>x.id===id); document.getElementById('p-name').value=p.name; document.getElementById('p-emoji').value=p.emoji||''; document.getElementById('p-cat').value=p.category; document.getElementById('p-cost').value=p.cost; document.getElementById('p-price').value=p.price; document.getElementById('p-stock').value=p.stock; document.getElementById('p-minstock').value=p.minStock; }
  else ['p-name','p-emoji','p-cat','p-cost','p-price','p-stock','p-minstock'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('modal-product').classList.add('open');
}

function saveProduct() {
  const name=document.getElementById('p-name').value.trim(), price=parseFloat(document.getElementById('p-price').value);
  if (!name||isNaN(price)) { toast('Completa nombre y precio','error'); return; }
  const data={ name, emoji:document.getElementById('p-emoji').value||'üì¶', category:document.getElementById('p-cat').value||'General', cost:parseFloat(document.getElementById('p-cost').value)||0, price, stock:parseInt(document.getElementById('p-stock').value)||0, minStock:parseInt(document.getElementById('p-minstock').value)||5 };
  if (editingProductId) { Object.assign(store.products.find(p=>p.id===editingProductId),data); toast('Producto actualizado'); }
  else { store.products.push({id:store.nextProductId++,...data}); toast('Producto creado'); }
  save(); closeModal('modal-product'); renderProducts();
}

function deleteProduct(id) {
  if (!confirm('¬øEliminar este producto?')) return;
  store.products=store.products.filter(p=>p.id!==id);
  save(); renderProducts(); toast('Producto eliminado');
}

// ======================== INVENTARIO ========================
function renderInventory() {
  const canAdjust = currentUser.role==='admin'||currentUser.role==='bodega';
  const low=store.products.filter(p=>p.stock<=p.minStock).length, out=store.products.filter(p=>p.stock===0).length;
  const val=store.products.reduce((a,p)=>a+p.cost*p.stock,0);
  document.getElementById('inv-cards').innerHTML=`
    <div class="card"><div class="card-label">TOTAL PRODUCTOS</div><div class="card-value accent">${store.products.length}</div></div>
    <div class="card"><div class="card-label">STOCK BAJO</div><div class="card-value ${low>0?'red':'green'}">${low}</div><div class="card-sub">requieren reposici√≥n</div></div>
    <div class="card"><div class="card-label">SIN STOCK</div><div class="card-value ${out>0?'red':'green'}">${out}</div></div>
    <div class="card"><div class="card-label">VALOR EN STOCK</div><div class="card-value blue">$${val.toFixed(2)}</div></div>
  `;
  if (document.getElementById('btn-adjust')) document.getElementById('btn-adjust').style.display = canAdjust?'':'none';
  document.getElementById('inventory-table').innerHTML=store.products.map(p=>{
    const s=p.stock===0?['SIN STOCK','red']:p.stock<=p.minStock?['STOCK BAJO','yellow']:['OK','green'];
    return `<tr><td>${p.emoji||'üì¶'} ${p.name}</td><td style="font-weight:700">${p.stock}</td><td style="color:var(--text-muted)">${p.minStock}</td><td><span class="badge ${s[1]}">${s[0]}</span></td></tr>`;
  }).join('');
}

function openAdjustModal() {
  document.getElementById('adj-product').innerHTML=store.products.map(p=>`<option value="${p.id}">${p.emoji||'üì¶'} ${p.name} (stock: ${p.stock})</option>`).join('');
  document.getElementById('adj-qty').value=''; document.getElementById('adj-reason').value='';
  document.getElementById('modal-adjust').classList.add('open');
}

function applyAdjust() {
  const pid=parseInt(document.getElementById('adj-product').value), type=document.getElementById('adj-type').value, qty=parseInt(document.getElementById('adj-qty').value);
  if (isNaN(qty)||qty<0) { toast('Ingresa una cantidad v√°lida','error'); return; }
  const p=store.products.find(x=>x.id===pid);
  if (type==='add') p.stock+=qty; else if (type==='remove') p.stock=Math.max(0,p.stock-qty); else p.stock=qty;
  save(); closeModal('modal-adjust'); renderInventory();
  toast(`Stock de ${p.name} actualizado a ${p.stock}`);
}

// ======================== CLIENTES ========================
function renderClients() {
  document.getElementById('clients-table').innerHTML=store.clients.map(c=>{
    const t=store.sales.filter(s=>s.client===c.name).reduce((a,s)=>a+s.total,0);
    return `<tr><td><strong>${c.name}</strong></td><td>${c.phone||'‚Äî'}</td><td>${c.email||'‚Äî'}</td><td style="color:var(--green);font-weight:700">$${t.toFixed(2)}</td><td><button class="btn btn-danger btn-sm" onclick="deleteClient(${c.id})">üóëÔ∏è</button></td></tr>`;
  }).join('')||'<tr><td colspan="5" style="text-align:center;color:var(--text-muted)">Sin clientes</td></tr>';
}

function openClientModal() { document.getElementById('modal-client').classList.add('open'); }

function saveClient() {
  const name=document.getElementById('c-name').value.trim();
  if (!name) { toast('Ingresa el nombre','error'); return; }
  store.clients.push({id:store.nextClientId++,name,phone:document.getElementById('c-phone').value,email:document.getElementById('c-email').value,notes:document.getElementById('c-notes').value});
  ['c-name','c-phone','c-email','c-notes'].forEach(id=>document.getElementById(id).value='');
  save(); closeModal('modal-client'); renderClients(); toast('Cliente agregado');
}

function deleteClient(id) {
  if (!confirm('¬øEliminar este cliente?')) return;
  store.clients=store.clients.filter(c=>c.id!==id);
  save(); renderClients(); toast('Cliente eliminado');
}

// ======================== REPORTES ========================
function renderReports() {
  const tot=store.sales.reduce((a,s)=>a+s.total,0), profit=calcProfit(), avg=store.sales.length?tot/store.sales.length:0;
  const bestClient=getBestClient();
  document.getElementById('report-cards').innerHTML=`
    <div class="card"><div class="card-label">INGRESOS TOTALES</div><div class="card-value green">$${tot.toFixed(2)}</div></div>
    <div class="card"><div class="card-label">GANANCIA TOTAL</div><div class="card-value blue">$${profit.toFixed(2)}</div></div>
    <div class="card"><div class="card-label">TICKET PROMEDIO</div><div class="card-value accent">$${avg.toFixed(2)}</div></div>
    <div class="card"><div class="card-label">MEJOR CLIENTE</div><div class="card-value" style="font-size:16px">${bestClient}</div></div>
  `;
  const top=getTopProducts(5), maxQ=top[0]?.qty||1;
  document.getElementById('report-top-chart').innerHTML=top.map(p=>`
    <div class="bar-row"><div class="bar-label">${p.emoji} ${p.name}</div><div class="bar-track"><div class="bar-fill" style="width:${p.qty/maxQ*100}%"></div></div><div class="bar-val">$${p.revenue.toFixed(0)}</div></div>
  `).join('')||'<div style="padding:16px;color:var(--text-muted);font-size:13px">Sin datos</div>';
  const payT={};
  store.sales.forEach(s=>{ payT[s.payment]=(payT[s.payment]||0)+s.total; });
  const maxP=Math.max(...Object.values(payT),1);
  document.getElementById('report-payment-chart').innerHTML=Object.entries(payT).map(([m,v])=>`
    <div class="bar-row"><div class="bar-label">${m}</div><div class="bar-track"><div class="bar-fill" style="width:${v/maxP*100}%;background:var(--blue)"></div></div><div class="bar-val">$${v.toFixed(0)}</div></div>
  `).join('')||'<div style="padding:16px;color:var(--text-muted);font-size:13px">Sin datos</div>';
  const cats={};
  store.sales.forEach(sale=>sale.items.forEach(item=>{
    const p=store.products.find(x=>x.name===item.name), cat=p?.category||'Otros';
    if (!cats[cat]) cats[cat]={products:new Set(),units:0,revenue:0};
    cats[cat].products.add(item.name); cats[cat].units+=item.qty; cats[cat].revenue+=item.price*item.qty;
  }));
  document.getElementById('category-report-table').innerHTML=Object.entries(cats).map(([cat,d])=>`
    <tr><td><span class="badge yellow">${cat}</span></td><td>${d.products.size}</td><td>${d.units}</td><td style="color:var(--green);font-weight:700">$${d.revenue.toFixed(2)}</td></tr>
  `).join('')||'<tr><td colspan="4" style="text-align:center;color:var(--text-muted)">Sin datos</td></tr>';
}

function getBestClient() {
  const t={};
  store.sales.forEach(s=>{ if (s.client!=='Consumidor Final') t[s.client]=(t[s.client]||0)+s.total; });
  const b=Object.entries(t).sort((a,b)=>b[1]-a[1])[0];
  return b?b[0].split(' ')[0]:'‚Äî';
}

// ======================== HISTORIAL ========================
function renderHistorial() {
  const fd=document.getElementById('filter-date')?.value;
  const sales=[...store.sales].sort((a,b)=>b.id-a.id).filter(s=>!fd||s.date===fd);
  document.getElementById('historial-table').innerHTML=sales.map(s=>`
    <tr>
      <td style="color:var(--text-muted)">#${s.id}</td>
      <td>${s.date}</td>
      <td style="font-size:13px">${s.seller||'‚Äî'}</td>
      <td>${s.client}</td>
      <td style="font-size:13px;color:var(--text-muted)">${s.items.map(i=>`${i.qty}x ${i.name}`).join(', ')}</td>
      <td><span class="badge ${s.payment==='Efectivo'?'green':'yellow'}">${s.payment}</span></td>
      <td style="color:var(--accent);font-weight:700">$${s.total.toFixed(2)}</td>
    </tr>
  `).join('')||'<tr><td colspan="7" style="text-align:center;color:var(--text-muted)">Sin ventas</td></tr>';
}

// ======================== USUARIOS ========================
function renderUsers() {
  const roleColors = { admin:'role-admin', vendedor:'role-vendedor', bodega:'role-bodega' };
  const roleLabels = { admin:'Admin', vendedor:'Vendedor', bodega:'Bodega' };
  document.getElementById('users-table').innerHTML=store.users.map(u=>`
    <tr>
      <td><strong>${u.username}</strong></td>
      <td>${u.fullname}</td>
      <td style="color:var(--text-muted)">${u.email}</td>
      <td><span class="user-role-tag ${roleColors[u.role]}">${roleLabels[u.role]}</span></td>
      <td>
        ${u.id!==currentUser.id?`<button class="btn btn-danger btn-sm" onclick="deleteUser(${u.id})">üóëÔ∏è</button>`:'<span style="font-size:12px;color:var(--text-muted)">T√∫</span>'}
      </td>
    </tr>
  `).join('');
}

function openUserModal() {
  editingUserId=null;
  document.getElementById('modal-user-title').textContent='Nuevo Usuario';
  ['u-username','u-fullname','u-email','u-pass','u-pass2'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('modal-user').classList.add('open');
}

function saveUser() {
  const username=document.getElementById('u-username').value.trim();
  const fullname=document.getElementById('u-fullname').value.trim();
  const email=document.getElementById('u-email').value.trim();
  const role=document.getElementById('u-role').value;
  const pass=document.getElementById('u-pass').value;
  const pass2=document.getElementById('u-pass2').value;
  if (!username||!fullname||!pass) { toast('Completa los campos requeridos','error'); return; }
  if (pass!==pass2) { toast('Las contrase√±as no coinciden','error'); return; }
  if (pass.length<6) { toast('La contrase√±a debe tener al menos 6 caracteres','error'); return; }
  if (store.users.find(u=>u.username===username)) { toast('Ese nombre de usuario ya existe','error'); return; }
  store.users.push({id:store.nextUserId++, username, fullname, email, role, password:pass});
  save(); closeModal('modal-user'); renderUsers(); toast('Usuario creado');
}

function deleteUser(id) {
  if (id===currentUser.id) { toast('No puedes eliminarte a ti mismo','error'); return; }
  if (!confirm('¬øEliminar este usuario?')) return;
  store.users=store.users.filter(u=>u.id!==id);
  save(); renderUsers(); toast('Usuario eliminado');
}

// ======================== MODALS ========================
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('open');}));

// Enter key on login
document.getElementById('login-pass').addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });
document.getElementById('login-user').addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });

// ======================== INIT ========================
tryAutoLogin();
</script>
</body>
</html>
